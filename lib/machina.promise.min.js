/*
	machina.promise - A lightweight Promises/A compliant implementation for projects already using the machina state machine library.
	version:	0.1.2
	author:		Doug Neiner <dneiner@appendto.com>
	copyright:	2012 appendTo, LLC
	license:	Dual licensed
				MIT (http://opensource.org/licenses/mit-license)
				GPL (http://opensource.org/licenses/GPL-2.0)
*/
(function(e,t){if("object"==typeof module&&module.exports){var n=require("lodash");module.exports=t(n,require("machina"))}else"function"==typeof define&&define.amd?define(["lodash","machina"],function(n,i){return t(n,i,e)}):e.machina.Promise=t(e._,e.machina,e)})(this,function(e,t){var n=t.Fsm.extend({initialState:"unfulfilled",initialize:function(){e.bindAll(this,"reject","fulfill","then")},reject:function(e){this.handle("process",{action:"failed",data:e})},fulfill:function(e){this.handle("process",{action:"fulfilled",data:e})},then:function(t,i){var l=this,f=new n,a=function(){l.off("fulfilled",a),l.off("failed",a);var e,u="fulfilled"===l.state,s=u?t:i;if(s){try{e=s.apply(null,arguments)}catch(d){return f.reject.call(null,d),undefined}n.useExtensions&&e&&e.then?e.then(f.fulfill,f.reject):f.fulfill.call(null,e)}else f[u?"fulfill":"reject"].apply(null,arguments)};return this.on("fulfilled",a),this.on("failed",a),n.useExtensions?e.defer(function(){l.handle("then")}):this.handle("then"),f},states:{unfulfilled:{process:function(e){this._data=e.data,this.transition(e.action),this.handle("then")}},fulfilled:{then:function(){this.emit("fulfilled",this._data)}},failed:{then:function(){this.emit("failed",this._data)}}}});return n.useExtensions=!0,n});